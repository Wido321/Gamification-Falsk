{% extends "base.html" %}
{% block title %}Tabella{% endblock %}
{% block content %}
<div class="tabella-container">
  <table class="tabella-moderna">
    <thead>
      <tr>
        <th style="width: 12.5%;">#</th>
        <th style="width: 12.5%;">Presenza</th>
        <th style="width: 12.5%;">Nome</th>
        <th style="width: 12.5%;">Stato</th>
        <th style="width: 12.5%;">Punti Aura</th>
        <th style="width: 12.5%;">Voti</th>
        <th style="width: 12.5%;">Probabilità</th>
        <th style="width: 10%;"></th>
      </tr>
    </thead>
    <tbody>
      {% for row in tabella_data %}
      <tr data-id="{{ row.id }}">
        <input type="hidden" class="stato-hidden" value="{{ row.stato }}">
        <td>{{ row.id }}</td>
        <td><input type="checkbox" {% if row.checked %}checked{% endif %} class="presence-checkbox" data-row="{{ row.id }}"></td>
        <td>{{ row.cognome }}</td>
        <td>
          <div class="stato-cerchi">
            {# Calcola il numero di slot memorizzati (2 char per slot) #}
            {% set slots = (row.stato | length) // 2 %}
            {% for j in range(slots) %}
              {% set code = row.stato[j*2:(j+1)*2] %}
              <span class="cerchio stato-{{ row.id }}-{{ j+1 }}" data-row="{{ row.id }}" data-index="{{ j+1 }}" data-diff="{% if code != '--' %}{% if code[1] == 'f' %}Facile{% elif code[1] == 'n' %}Normale{% elif code[1] == 'd' %}Difficile{% endif %}{% endif %}" title="{% if code != '--' %}{% if code[1] == 'f' %}Facile{% elif code[1] == 'n' %}Normale{% elif code[1] == 'd' %}Difficile{% endif %}{% endif %}" style="background-color: {% if code == 'Gf' %}#5eff4b{% elif code == 'Rf' %}#ff4848{% elif code == 'Gn' %}#4caf50{% elif code == 'Rn' %}#d8302d{% elif code == 'Gd' %}#147f00{% elif code == 'Rd' %}#7f0000{% else %}transparent{% endif %}"></span>
            {% endfor %}
          </div>
        </td>
  <td><input type="text" value="{{ row.punti }}" class="input-punti" readonly data-row="{{ row.id }}"></td>
  <td><span class="voto-display" data-row="{{ row.id }}">0</span></td>
  <td><input type="text" value="{{ row.probabilita }}%" class="input-prob" readonly data-row="{{ row.id }}"></td>
        <td><button class="btn-plus" data-row="{{ row.id }}" aria-label="Aumenta" title="Aumenta" style="font-size:2.2rem; font-weight:700; color:#fff; background:linear-gradient(135deg,#4158d0,#c850c0); border:none; border-radius:50%; width:48px; height:48px; box-shadow:0 4px 16px rgba(65,88,208,0.18); display:flex; align-items:center; justify-content:center; cursor:pointer; transition:transform 0.15s;">+</button></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Reset Button -->
  <div style="margin-top: auto; text-align: left; margin-bottom: 20px; margin-left: 20px;">
    <button id="resetBtn" style="background: linear-gradient(135deg,#f44336,#d32f2f); color: #fff; border: none; border-radius: 8px; padding: 10px 16px; font-size: 0.9rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 16px rgba(244,67,54,0.3); transition: transform 0.15s;">Reset Dati</button>
  </div>
</div>

<!-- Dice Button PNG -->
<div style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
  <div style="position: relative; width: 300px; height: 360px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start;">
    <div id="selected-name" style="position: absolute; top: -120px; left: 50%; transform: translate(-50%, 0); z-index: 4000; font-size: 3rem; font-family: 'Poppins', sans-serif; font-weight: 800; color: #fff; text-shadow: 0 4px 32px #4158d0, 0 0 64px #c850c0; pointer-events: none; opacity: 0; transition: opacity 0.3s;"></div>
    <div id="dice-main-number" style="position: absolute; top: 0; left: 50%; transform: translate(-50%, 0); z-index: 3999; width: 300px; height: 300px; background: linear-gradient(135deg,#4158d0,#c850c0); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 5rem; font-family: 'Poppins', sans-serif; font-weight: 800; color: #fff; box-shadow: 0 8px 32px rgba(65,88,208,0.22); border: 6px solid #fff; pointer-events: none; opacity: 0; transition: opacity 0.3s;"></div>
    <button id="diceBtn" class="dice-button-img" aria-label="Lancia il dado" style="background:none; border:none; padding:0; border-radius:50%; box-shadow:0 8px 32px rgba(65,88,208,0.22); cursor:pointer; width:300px; height:300px; display:flex; align-items:center; justify-content:center; overflow:hidden; position: relative;">
  <dotlottie-wc id="main-dice-lottie" src="https://lottie.host/be5df32d-5f20-4015-a1e4-b0b56c8934f8/PfUeITOeEI.lottie" style="width: 300px; height: 300px" autoplay loop></dotlottie-wc>
    </button>
  </div>
</div>

<!-- Overlay domanda -->
<!-- Overlay difficoltà -->
<div id="difficulty-overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(26,11,46,0.85); z-index:3500; justify-content:center; align-items:center;">
  <div style="background:rgba(255,255,255,0.08); border-radius:24px; box-shadow:0 8px 32px rgba(107,43,255,0.2); padding:36px 28px; text-align:center; font-family:'Poppins',sans-serif; font-size:1.9rem; color:#fff; max-width:520px; position:relative;">
    <button id="cancel-difficulty" style="position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.2); color: #fff; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 1.2rem; font-weight: bold; cursor: pointer;">×</button>
    <div id="difficulty-text" style="margin-bottom:24px; font-size:2rem; font-weight:700;">Che difficoltà deve essere la domanda per <span id="overlay-selected-name"></span>?</div>
    <div style="display:flex; justify-content:center; gap:12px;">
      <button class="diff-btn" data-diff="facile" style="background:linear-gradient(135deg,#4caf50,#2e7d32); color:#fff; font-size:1.1rem; font-weight:700; border:none; border-radius:12px; padding:12px 20px; cursor:pointer;">Facile</button>
      <button class="diff-btn" data-diff="normale" style="background:linear-gradient(135deg,#ffeb3b,#fbc02d); color:#000; font-size:1.1rem; font-weight:700; border:none; border-radius:12px; padding:12px 20px; cursor:pointer;">Normale</button>
      <button class="diff-btn" data-diff="difficile" style="background:linear-gradient(135deg,#f44336,#d32f2f); color:#fff; font-size:1.1rem; font-weight:700; border:none; border-radius:12px; padding:12px 20px; cursor:pointer;">Difficile</button>
    </div>
  </div>
</div>

<!-- Overlay domanda (dopo scelta difficoltà) -->
<div id="question-overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(26,11,46,0.85); z-index:3000; justify-content:center; align-items:center;">
  <div style="background:rgba(255,255,255,0.08); border-radius:24px; box-shadow:0 8px 32px rgba(107,43,255,0.2); padding:48px 32px; text-align:center; font-family:'Poppins',sans-serif; font-size:2rem; color:#fff; max-width:400px; position:relative;">
    <button id="cancel-question" style="position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.2); color: #fff; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 1.2rem; font-weight: bold; cursor: pointer;">×</button>
    <div id="question-text" style="margin-bottom:32px; font-size:2.2rem; font-weight:700;"><span id="overlay-selected-name"></span> ha risposto correttamente?</div>
    <button id="btn-correct" style="background:linear-gradient(135deg,#4caf50,#43ea7f); color:#fff; font-size:1.3rem; font-weight:600; border:none; border-radius:12px; padding:16px 32px; margin:0 16px; cursor:pointer;">Sì</button>
    <button id="btn-wrong" style="background:linear-gradient(135deg,#e74c3c,#ff6b6b); color:#fff; font-size:1.3rem; font-weight:600; border:none; border-radius:12px; padding:16px 32px; margin:0 16px; cursor:pointer;">No</button>
  </div>
</div>

<!-- Dice Animation Overlay -->
<div id="dice-animation-overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(26,11,46,0.85); z-index:4000; justify-content:center; align-items:center;">
  <div style="position:relative; width:300px; height:300px; display:flex; align-items:center; justify-content:center;">
  <dotlottie-wc id="dice-lottie" src="https://lottie.host/be5df32d-5f20-4015-a1e4-b0b56c8934f8/PfUeITOeEI.lottie" style="width: 300px; height: 300px; position:absolute; left:0; top:0; z-index:1;" autoplay loop></dotlottie-wc>
    <div id="dice-number" style="display:none; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); z-index:2; font-size:5rem; font-family:'Poppins',sans-serif; font-weight:800; color:#fff; text-shadow:0 4px 32px #4158d0,0 2px 8px #c850c0; background:rgba(65,88,208,0.18); border-radius:24px; padding:24px 64px; box-shadow:0 8px 32px rgba(65,88,208,0.18); transition:opacity 0.5s; pointer-events:none;"></div>
  </div>
</div>

<!-- Confirmation Overlay -->
<div id="confirmation-overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(26,11,46,0.85); z-index:4500; justify-content:center; align-items:center;">
  <div style="background:rgba(255,255,255,0.08); border-radius:24px; box-shadow:0 8px 32px rgba(107,43,255,0.2); padding:36px 28px; text-align:center; font-family:'Poppins',sans-serif; font-size:1.9rem; color:#fff; max-width:520px; position:relative;">
    <button id="cancel-confirmation" style="position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.2); color: #fff; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 1.2rem; font-weight: bold; cursor: pointer;">×</button>
    <div style="font-size: 4rem; margin-bottom: 20px;">☢️</div>
    <div id="confirmation-text" style="margin-bottom:24px; font-size:2rem; font-weight:700;">Attenzione</div>
    <div id="confirmation-message" style="margin-bottom:24px; font-size:1.5rem;"></div>
    <div style="display:flex; justify-content:center; gap:12px;">
      <button id="confirm-action" style="background:linear-gradient(135deg,#f44336,#d32f2f); color:#fff; font-size:1.1rem; font-weight:700; border:none; border-radius:12px; padding:12px 20px; cursor:pointer;">Conferma</button>
      <button id="cancel-action" style="background:linear-gradient(135deg,#4caf50,#2e7d32); color:#fff; font-size:1.1rem; font-weight:700; border:none; border-radius:12px; padding:12px 20px; cursor:pointer;">Annulla</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.8.1/dist/dotlottie-wc.js" type="module"></script>
<script>
const names = {{ names|tojson }};
// Funzione per calcolare le probabilità basate sui pallini vuoti
function calculateProbabilities() {
  // Calcola probabilità basandosi sullo stato memorizzato (.stato-hidden)
  // e aggiorna la colonna Voti secondo la formula richiesta.
  let totalEmpty = 0;
  const rowEmpties = [];
  const weights = []; // pesi normalizzati restituiti

  // Numero di slot visibili (renderizzati)
  const slotsVisible = visibleRows * VISIBLE_COLS;


  // Itera su ogni riga della tabella (usando selettori relativi al tr)
  document.querySelectorAll('tbody tr').forEach((tr, idx) => {
    const checkbox = tr.querySelector('.presence-checkbox');
    if (!checkbox || !checkbox.checked) {
      rowEmpties[idx] = 0;
      // Aggiorna input-prob e input-voti a 0
      const inputProb = tr.querySelector('.input-prob');
      if (inputProb) inputProb.value = '0.0%';
      const inputVoti = tr.querySelector('.voto-display');
      if (inputVoti) inputVoti.textContent = '0';
      weights[idx] = 0;
      return;
    }

    const statoHidden = tr.querySelector('.stato-hidden');
    const stato = (statoHidden ? statoHidden.value : '') || '';

    // Conta palline vuote tra gli slot visibili
    let emptyCount = 0;
    // Per il calcolo dei voti
    let x = 0; // somma pesi risposte corrette
    let y = 0; // somma pesi di tutte le domande risposte (corrette + sbagliate)

    for (let i = 0; i < slotsVisible; i++) {
      const code = stato.length >= (i+1)*2 ? stato.substr(i*2,2) : '--';
      if (code === '--') {
        emptyCount++;
        continue;
      }
      // code è tipo 'Gf' o 'Rn'
      const outcome = code.charAt(0); // 'G' o 'R'
      const diffChar = code.charAt(1); // 'f'|'n'|'d'
      // Per invertire l'impatto sul voto quando la risposta è sbagliata
      // manteniamo i pesi normali per le risposte corrette, ma invertiamo
      // il peso per le risposte sbagliate tra 'facile' e 'difficile'.
      const wCorrect = diffChar === 'd' ? 3 : diffChar === 'n' ? 2 : 1;
      const wWrong = diffChar === 'd' ? 1 : diffChar === 'n' ? 2 : 3;
      if (outcome === 'G') {
        // risposta corretta: conta con peso normale
        y += wCorrect;
        x += wCorrect;
      } else if (outcome === 'R') {
        // risposta sbagliata: conta con peso invertito per f<->d
        y += wWrong;
      }
    }

    rowEmpties[idx] = emptyCount;
    totalEmpty += emptyCount;

    // Calcola e aggiorna campo Voti
    const inputVoti = tr.querySelector('.voto-display');
    if (inputVoti) {
      if (x === 0 && y === 0) {
        inputVoti.textContent = '0';
      } else {
        const val = (x / y) * 8 + 1;
        inputVoti.textContent = roundToHalf(val).toFixed(1);
      }
      // Aggiungi classe per ombra basata sul valore
      const val = parseFloat(inputVoti.textContent);
      inputVoti.classList.remove('voto-low', 'voto-high', 'voto-gold');
      if (val < 6) {
        inputVoti.classList.add('voto-low');
      } else if (val >= 9) {
        inputVoti.classList.add('voto-gold');
      } else {
        inputVoti.classList.add('voto-high');
      }
    }

    // Calcola probabilità placeholder (riempiamo dopo il loop usando empty counts)
    weights[idx] = null; // placeholder
  });

  // Aggiorna le probabilità in percentuale usando rowEmpties
  for (let i = 0; i < rowEmpties.length; i++) {
    const prob = totalEmpty > 0 ? (rowEmpties[i] / totalEmpty) * 100 : 0;
    // aggiorna il corrispondente input-prob nella riga i-esima (nell'ordine del DOM)
    const tr = document.querySelectorAll('tbody tr')[i];
    if (tr) {
      const inputProb = tr.querySelector('.input-prob');
      if (inputProb) inputProb.value = prob.toFixed(1) + '%';
    }
    weights[i] = totalEmpty > 0 ? rowEmpties[i] / totalEmpty : 0;
  }

  return weights;
}

// Arrotonda al mezzo più vicino (0.5)
function roundToHalf(n) {
  return Math.round(n * 2) / 2;
}

// Funzione per salvare la tabella
function saveTabella() {
  const data = [];
  document.querySelectorAll('tbody tr').forEach(tr => {
    const id = tr.dataset.id;
    const checked = tr.querySelector('.presence-checkbox').checked;
    const punti = parseInt(tr.querySelector('.input-punti').value) || 0;
    const probabilita = parseFloat(tr.querySelector('.input-prob').value) || 0;
    const stato = tr.querySelector('.stato-hidden').value;
    data.push({id, checked, punti, probabilita, stato});
  });
  fetch('/save_tabella', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  }).then(res => res.json()).then(data => console.log('Saved')).catch(err => console.error('Save failed', err));
}

// Funzione per selezione casuale pesata
function weightedRandom(weights) {
  const total = weights.reduce((a,b)=>a+b,0);
  let random = Math.random() * total;
  for (let i = 0; i < weights.length; i++) {
    random -= weights[i];
    if (random <= 0) return i+1; // righe 1-22
  }
  return 22; // fallback
}

// --- Gestione "sorteggiati oggi" (memorizzata in localStorage) ---
const DRAWN_STORE_KEY = 'gamification_drawn_list';
function _loadDrawnState() {
  try {
    const raw = localStorage.getItem(DRAWN_STORE_KEY);
    if (!raw) return {date: null, drawn: {}};
    return JSON.parse(raw);
  } catch (e) {
    return {date: null, drawn: {}};
  }
}
function _saveDrawnState(state) {
  localStorage.setItem(DRAWN_STORE_KEY, JSON.stringify(state));
}
function _todayString() {
  const d = new Date();
  return d.getFullYear() + '-' + (d.getMonth()+1) + '-' + d.getDate();
}
function _ensureTodayState() {
  const state = _loadDrawnState();
  const today = _todayString();
  if (state.date !== today) {
    const newState = {date: today, drawn: {}};
    _saveDrawnState(newState);
    return newState;
  }
  return state;
}
function markDrawn(row) {
  const name = getNameByRow(row).toUpperCase();
  const state = _ensureTodayState();
  state.drawn[name] = true;
  _saveDrawnState(state);
}
function isDrawn(row) {
  const name = getNameByRow(row).toUpperCase();
  const state = _ensureTodayState();
  return !!state.drawn[name];
}
function clearAllDrawn() {
  const state = {date: _todayString(), drawn: {}};
  _saveDrawnState(state);
}
function clearDrawnForRow(row) {
  const name = getNameByRow(row).toUpperCase();
  const state = _ensureTodayState();
  if (state.drawn[name]) delete state.drawn[name];
  _saveDrawnState(state);
}

// Calcola pesi effettivi escludendo chi è già stato sorteggiato oggi
function computeEffectiveWeights(originalWeights) {
  const eff = originalWeights.map((w,i) => {
    const row = i+1;
    return isDrawn(row) ? 0 : w;
  });
  const total = eff.reduce((a,b)=>a+b,0);
  // Se tutti sono stati sorteggiati -> reset e ritorna gli originali
  if (total === 0) {
    clearAllDrawn();
    return originalWeights.slice();
  }
  return eff;
}

// Funzione che decide se sopprimere la visualizzazione del sorteggio
function shouldSuppressShow(name) {
  // Se è BASILI allora il 50% delle volte non viene mostrato e si rifà il sorteggio
  if (!name) return false;
  if (name.toUpperCase() === 'BASILI') {
    return Math.random() < 0.5;
  }
  return false;
}

// Dado Lottie con cerchio numero
const diceBtn = document.getElementById('diceBtn');
const diceLottie = document.getElementById('main-dice-lottie');
const diceMainNumber = document.getElementById('dice-main-number');

// All'avvio parte l'animazione, poi si ferma
window.addEventListener('DOMContentLoaded', () => {
  if (diceLottie) {
    diceLottie.setAttribute('autoplay', '');
    diceLottie.removeAttribute('loop');
    setTimeout(() => {
      diceLottie.removeAttribute('autoplay');
      diceLottie.frame = 120;
    }, 2200); // durata animazione
  }
  // Calcola visibleRows in base allo stato salvato (preserve righe aggiunte)
  computeVisibleRowsFromState();
  // Calcola probabilità iniziali
  calculateProbabilities();
  // render stato iniziale
  renderStatoForAll();
});

// Calcola quante righe visibili mostrare basandosi sullo stato più lungo tra le righe
function computeVisibleRowsFromState() {
  let maxSlots = 0;
  document.querySelectorAll('tbody tr').forEach(tr => {
    const statoHidden = tr.querySelector('.stato-hidden');
    if (!statoHidden) return;
    const slots = Math.floor((statoHidden.value || '').length / 2);
    if (slots > maxSlots) maxSlots = slots;
  });
  // Imposta visibleRows in base al numero di slot (diviso 5, arrotondato per eccesso)
  if (maxSlots > 0) visibleRows = Math.ceil(maxSlots / VISIBLE_COLS);
}

// ---- Nuove funzioni per rendering dinamico e estensione delle righe ----
const VISIBLE_COLS = 5; // 5 palline per riga visibile
let visibleRows = 1; // quante righe visibili mostriamo (incrementa quando una riga viene completata)

// mappa colori unificata (usata sia per rendering che per aggiornamenti inline)
const COLOR_MAP = {
  'facile': { 'correct': '#5eff4b', 'wrong': '#ff4848' },
  'normale': { 'correct': '#4caf50', 'wrong': '#d8302d' },
  'difficile': { 'correct': '#147f00', 'wrong': '#7f0000' }
};

function getColorForCode(code) {
  if (!code || code === '--') return 'transparent';
  const outcome = code.charAt(0); // 'G' or 'R'
  const diffChar = code.charAt(1); // 'f'|'n'|'d'
  const diffKey = diffChar === 'd' ? 'difficile' : diffChar === 'n' ? 'normale' : 'facile';
  return outcome === 'G' ? COLOR_MAP[diffKey]['correct'] : COLOR_MAP[diffKey]['wrong'];
}

function renderStatoForAll() {
  // Per ogni riga nella tabella rigeneriamo i pallini in base al valore presente in .stato-hidden
  document.querySelectorAll('tbody tr').forEach(tr => {
    const rowId = tr.dataset.id;
    const statoHidden = tr.querySelector('.stato-hidden');
    const container = tr.querySelector('.stato-cerchi');
    const stato = (statoHidden ? statoHidden.value : '') || '';
    const totalVisibleSlots = visibleRows * VISIBLE_COLS;
    let html = '';
    for (let i = 0; i < totalVisibleSlots; i++) {
      const code = stato.length >= (i+1)*2 ? stato.substr(i*2,2) : '--';
      const color = getColorForCode(code);
      const idx = i+1;
      const diffChar = code.charAt(1);
      let diffText = '';
      if (code !== '--') {
        if (diffChar === 'f') diffText = 'Facile';
        else if (diffChar === 'n') diffText = 'Normale';
        else if (diffChar === 'd') diffText = 'Difficile';
      }
      html += `<span class="cerchio stato-${rowId}-${idx}" data-row="${rowId}" data-index="${idx}" data-diff="${diffText}" title="${diffText}" style="background-color: ${color}"></span>`;
    }
    if (container) container.innerHTML = html;
  });
}

function ensureStoredSlotsForVisible() {
  // Garantisce che lo stato memorizzato abbia almeno visibleRows*VISIBLE_COLS slot per ogni riga
  const neededSlots = visibleRows * VISIBLE_COLS;
  let changed = false;
  document.querySelectorAll('tbody tr').forEach(tr => {
    const statoHidden = tr.querySelector('.stato-hidden');
    if (!statoHidden) return;
    const currSlots = Math.floor((statoHidden.value || '').length / 2);
    if (currSlots < neededSlots) {
      const toAdd = neededSlots - currSlots;
      statoHidden.value = statoHidden.value + '--'.repeat(toAdd);
      changed = true;
    }
  });
  return changed;
}

function checkAndExtendIfNeeded() {
  // Se almeno una riga ha completato tutti i pallini visibili, estende di una riga (5 slot) per tutti
  const totalVisibleSlots = visibleRows * VISIBLE_COLS;
  let anyCompleted = false;
  document.querySelectorAll('tbody tr').forEach(tr => {
    const statoHidden = tr.querySelector('.stato-hidden');
    const stato = (statoHidden ? statoHidden.value : '') || '';
    let completed = true;
    for (let i = 0; i < totalVisibleSlots; i++) {
      const code = stato.length >= (i+1)*2 ? stato.substr(i*2,2) : '--';
      if (code === '--') { completed = false; break; }
    }
    if (completed) anyCompleted = true;
  });
  if (anyCompleted) {
    // Aggiungi 5 slot a tutti
    visibleRows += 1;
    document.querySelectorAll('tbody tr').forEach(tr => {
      const statoHidden = tr.querySelector('.stato-hidden');
      if (statoHidden) statoHidden.value = (statoHidden.value || '') + '--'.repeat(VISIBLE_COLS);
    });
    // Rigeneriamo e salviamo
    renderStatoForAll();
    saveTabella();
  }
}

// Assicuriamoci che lo stato salvato contenga almeno la prima riga (5 slot)
ensureStoredSlotsForVisible();
renderStatoForAll();


function showDiceNumber(num) {
  diceMainNumber.textContent = num;
  diceMainNumber.style.opacity = '1';
  diceMainNumber.classList.add('illuminated');
  const selectedNameDiv = document.getElementById('selected-name');
  const name = getNameByRow(num);
  const capitalizedName = name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();
  selectedNameDiv.textContent = capitalizedName;
  selectedNameDiv.style.opacity = '1';
}

function hideDiceNumber() {
  diceMainNumber.style.opacity = '0';
  diceMainNumber.classList.remove('illuminated');
  const selectedNameDiv = document.getElementById('selected-name');
  selectedNameDiv.style.opacity = '0';
}

function startDiceAnimation() {
  // Nascondi il dado
  diceLottie.style.display = 'none';
  setTimeout(() => {
    // Mostra e ricomincia animazione
    diceLottie.style.display = '';
    diceLottie.removeAttribute('autoplay');
    diceLottie.frame = 0;
    diceLottie.load?.(diceLottie.src);
    setTimeout(() => {
      diceLottie.setAttribute('autoplay','');
      setTimeout(() => {
        diceLottie.removeAttribute('autoplay');
        diceLottie.frame = 120;
      }, 2200);
    }, 50);
  }, 10);
}

diceBtn.addEventListener('click', function() {
  this.classList.add('pressed');
  setTimeout(()=>this.classList.remove('pressed'), 160);
  // Calcola probabilità
  const weights = calculateProbabilities();
  // Applica l'esclusione "sorteggiati oggi" senza alterare la colonna probabilità
  let effective = computeEffectiveWeights(weights);
  // Estrazione con possibile "soppressione" per alcuni nomi (es. BASILI)
  let attempts = 0;
  let selected = weightedRandom(effective);
  // Se il selezionato è da sopprimere, ripeti la scelta fino a un limite (non tocciamo le probabilità visualizzate)
  while (attempts < 10 && shouldSuppressShow(getNameByRow(selected))) {
    attempts += 1;
    // ricomputiamo pesi (nel caso qualcuno sia stato segnato nel frattempo)
    effective = computeEffectiveWeights(weights);
    selected = weightedRandom(effective);
    // Non mostriamo nulla qui (soppressione): semplicemente proseguiamo la selezione
  }

  // Ricomincia animazione Lottie ogni estrazione
  startDiceAnimation();

  // Mostriamo il risultato finale
  showDiceNumber(selected);

  // Segniamo il sorteggiato come "sorteggiato oggi" prima di aprire la scelta di difficoltà
  markDrawn(selected);

  // Apri la scelta di difficoltà
  showDifficultyChooser(selected);
});

// Overlay domanda
function showQuestion(row) {
  const overlay = document.getElementById('question-overlay');
  overlay.style.display = 'flex';
  overlay.dataset.row = row;
  const name = getNameByRow(row);
  const capitalizedName = name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();
  document.getElementById('overlay-selected-name').textContent = capitalizedName;
}

// Mostra la scelta di difficoltà prima della domanda
function showDifficultyChooser(row) {
  const overlay = document.getElementById('difficulty-overlay');
  overlay.style.display = 'flex';
  overlay.dataset.row = row;
  const name = getNameByRow(row);
  const capitalizedName = name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();
  document.getElementById('overlay-selected-name').textContent = capitalizedName;
}

// Nascondi chooser
function hideDifficultyChooser() {
  const overlay = document.getElementById('difficulty-overlay');
  overlay.style.display = 'none';
}

// (mappa colori rimossa qui: si usa la mappa unificata già dichiarata sopra)

// Funzione per ottenere il nome dalla riga
function getNameByRow(row) {
  return names[row-1] || 'Persona ' + row;
}

// registra click sui bottoni difficoltà
document.querySelectorAll('.diff-btn').forEach(function(b){
  b.addEventListener('click', function(){
    const diff = b.dataset.diff; // 'facile'|'normale'|'difficile'
    const row = document.getElementById('difficulty-overlay').dataset.row;
    // chiudi chooser e apri la domanda
    hideDifficultyChooser();
    // salviamo la difficoltà scelta nell'overlay domanda per usarla dopo
    const questionOverlay = document.getElementById('question-overlay');
    questionOverlay.dataset.row = row;
    questionOverlay.dataset.diff = diff;
    showQuestion(row);
  });
});
document.getElementById('btn-correct').onclick = function() {
  const row = document.getElementById('question-overlay').dataset.row;
  const diff = document.getElementById('question-overlay').dataset.diff || 'normale';
  // Trova la prima pallina vuota e colorala secondo la mappa
  const cerchi = document.querySelectorAll('.cerchio[data-row="' + row + '"]');
  for (let c of cerchi) {
    const bg = (c.style.backgroundColor || '').trim();
    if (!bg || bg === 'transparent' || bg === 'rgba(0, 0, 0, 0)') {
      c.style.backgroundColor = COLOR_MAP[diff]['correct'];
      break;
    }
  }
  // Aggiorna stato string
  const statoHidden = document.querySelector(`tr[data-id="${row}"] .stato-hidden`);
  let stato = statoHidden.value;
  const index = stato.indexOf('--');
  if (index !== -1) {
    stato = stato.substring(0, index) + 'G' + diff.charAt(0) + stato.substring(index+2);
    statoHidden.value = stato;
  }
  // Aggiungi punti
  const inputPunti = document.querySelector(`.input-punti[data-row="${row}"]`);
  let current = parseInt(inputPunti.value) || 0;
  let add = diff === 'facile' ? 10 : diff === 'normale' ? 20 : 50;
  inputPunti.value = current + add;
  document.getElementById('question-overlay').style.display = 'none';
  // Aggiorna UI e dati dopo la risposta
  ensureStoredSlotsForVisible();
  renderStatoForAll();
  // Ricalcola probabilità e voti dopo la risposta
  calculateProbabilities();
  // Salva
  saveTabella();
  // Controlla se estendere la riga visibile per tutti (potrebbe aggiungere slot e salvare di nuovo)
  checkAndExtendIfNeeded();
  fetch('/save_storico', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({cognome: names[row - 1], difficolta: diff, risultato: 'correct'})
  });
  // Dopo il sorteggio, nascondi il numero e mostra l'animazione
  hideDiceNumber();
  startDiceAnimation();
};
document.getElementById('btn-wrong').onclick = function() {
  const row = document.getElementById('question-overlay').dataset.row;
  const diff = document.getElementById('question-overlay').dataset.diff || 'normale';
  // Trova la prima pallina vuota e colorala secondo la mappa
  const cerchi = document.querySelectorAll('.cerchio[data-row="' + row + '"]');
  for (let c of cerchi) {
    const bg = (c.style.backgroundColor || '').trim();
    if (!bg || bg === 'transparent' || bg === 'rgba(0, 0, 0, 0)') {
      c.style.backgroundColor = COLOR_MAP[diff]['wrong'];
      break;
    }
  }
  // Aggiorna stato string
  const statoHidden = document.querySelector(`tr[data-id="${row}"] .stato-hidden`);
  let stato = statoHidden.value;
  const index = stato.indexOf('--');
  if (index !== -1) {
    stato = stato.substring(0, index) + 'R' + diff.charAt(0) + stato.substring(index+2);
    statoHidden.value = stato;
  }
  // Sottrai punti: invertiamo la perdita per facile <-> difficile
  const inputPunti = document.querySelector(`.input-punti[data-row="${row}"]`);
  let current = parseInt(inputPunti.value) || 0;
  let subtract = diff === 'facile' ? 50 : diff === 'normale' ? 20 : 10;
  inputPunti.value = current - subtract;
  document.getElementById('question-overlay').style.display = 'none';
  // Aggiorna UI e dati dopo la risposta
  ensureStoredSlotsForVisible();
  renderStatoForAll();
  // Ricalcola probabilità e voti dopo la risposta
  calculateProbabilities();
  // Salva
  saveTabella();
  // Controlla se estendere la riga visibile per tutti (potrebbe aggiungere slot e salvare di nuovo)
  checkAndExtendIfNeeded();
  fetch('/save_storico', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({cognome: names[row - 1], difficolta: diff, risultato: 'wrong'})
  });
  // Dopo il sorteggio, nascondi il numero e mostra l'animazione
  hideDiceNumber();
  startDiceAnimation();
};

// Colonna +
document.querySelectorAll('.btn-plus').forEach(function(btn) {
  btn.addEventListener('click', function() {
    const row = btn.dataset.row;
    // Premendo + si rimuove il flag "sorteggiato oggi" per permettere di essere sorteggiati nuovamente
    clearDrawnForRow(row);
    showDifficultyChooser(row);
  });
});

// Cancel draw function
function cancelDraw() {
  hideDifficultyChooser();
  document.getElementById('question-overlay').style.display = 'none';
  document.getElementById('overlay-selected-name').textContent = '';
  hideDiceNumber();
  // Reset dice to initial state
  diceLottie.frame = 120;
}

// Event listeners for cancel buttons
document.getElementById('cancel-difficulty').addEventListener('click', cancelDraw);
document.getElementById('cancel-question').addEventListener('click', cancelDraw);

// Confirmation overlay functions
let confirmCallback = null;
function showConfirmation(message, callback) {
  document.getElementById('confirmation-message').textContent = message;
  confirmCallback = callback;
  document.getElementById('confirmation-overlay').style.display = 'flex';
}
function hideConfirmation() {
  document.getElementById('confirmation-overlay').style.display = 'none';
  confirmCallback = null;
}
document.getElementById('confirm-action').addEventListener('click', function() {
  if (confirmCallback) confirmCallback();
  hideConfirmation();
});
document.getElementById('cancel-action').addEventListener('click', hideConfirmation);
document.getElementById('cancel-confirmation').addEventListener('click', hideConfirmation);

// Reset button event listener
document.getElementById('resetBtn').addEventListener('click', function() {
  showConfirmation('Sei sicuro di voler azzerare tutti i dati? Questo cancellerà la tabella e lo storico.', () => {
    fetch('/reset_data', {
      method: 'POST'
    }).then(res => res.json()).then(data => {
      if (data.success) {
        window.location.reload();
      }
    }).catch(err => console.error('Reset failed', err));
  });
});

// Save on checkbox change
document.querySelectorAll('.presence-checkbox').forEach(cb => {
  cb.addEventListener('change', saveTabella);
});
</script>

{% endblock %}
<style>
@import url('https://fonts.googleapis.com/css?family=Poppins:400,500,600,700&display=swap');
body {
  font-family: 'Poppins', 'Segoe UI', Arial, sans-serif;
  background: #f2f2f2;
}
.navbar-custom {
  margin-bottom: 32px;
  padding: 0 0 0 24px;
}
.navbar-custom ul {
  list-style: none;
  display: flex;
  gap: 32px;
  padding: 0;
}
.navbar-custom li {
  display: inline-block;
}
.navbar-custom a {
  color: #4158d0;
  font-weight: 600;
  text-decoration: none;
  font-size: 1.1rem;
  padding: 8px 16px;
  border-radius: 6px;
  transition: background 0.2s;
}
.navbar-custom a:hover {
  background: #e9e9f7;
}
.tabella-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 70vh;
  width: 100%;
  padding: 32px 0;
  overflow-x: auto;
}
.tabella-moderna {
  width: 98%;
  max-width: 1100px;
  border-collapse: separate;
  border-spacing: 0;
  background: #fff;
  box-shadow: 0 8px 32px rgba(65,88,208,0.10);
  border-radius: 18px;
  overflow: visible;
  margin: 0 auto;
  border: 1.5px solid #c850c0;
  table-layout: fixed;
}
.tabella-moderna th {
  background: linear-gradient(-135deg, #c850c0, #4158d0);
  color: #fff;
  font-size: 1.15rem;
  font-weight: 700;
  padding: 20px 12px;
  border-bottom: 2px solid #4158d0;
  text-align: center;
  letter-spacing: 0.5px;
  white-space: nowrap;
}
.tabella-moderna td {
  padding: 18px 10px;
  border-bottom: 1px solid #e3e6ee;
  text-align: center;
  font-size: 1.05rem;
  background: #fff;
  transition: background 0.2s;
}
.tabella-moderna tbody tr:nth-child(even) td {
  background: #f7f2fa;
}
.tabella-moderna tbody tr:hover td {
  background: #e9e9f7;
}
.input-nome, .input-prob {
  width: 90%;
  padding: 8px 12px;
  border: 1.5px solid #bfc7e3;
  border-radius: 8px;
  font-size: 1.05rem;
  background: #f7f8fa;
  transition: border 0.2s, background 0.2s;
}
.input-punti {
  width: 90%;
  padding: 8px 12px;
  border: 1.5px solid #bfc7e3;
  border-radius: 8px;
  font-size: 1.05rem;
  background: #f7f8fa;
  transition: border 0.2s, background 0.2s;
}
.input-nome:focus, .input-punti:focus, .input-prob:focus {
  border: 2px solid #4158d0;
  background: #fff;
}

.stato-cerchi {
  display: flex;
  flex-wrap: wrap;
  gap: 18px;
  justify-content: center;
  align-items: center;
  margin: 0 auto;
}
.cerchio {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2.5px solid #c850c0;
  box-shadow: 0 2px 8px rgba(65,88,208,0.10);
  font-size: 1.5rem;
  font-weight: 700;
  color: #fff;
  background: transparent;
  position: relative;
  transition: transform 0.2s ease;
}
.cerchio:hover {
  transform: scale(1.1);
}
.cerchio::after {
  content: attr(data-diff);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.8);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.8rem;
  white-space: nowrap;
  visibility: hidden;
  pointer-events: none;
  z-index: 1000;
}
.cerchio:hover::after {
  visibility: visible;
}

@media (max-width: 1024px) and (min-width: 901px) {
  .tabella-moderna {
    width: 100%;
    max-width: none;
  }
  .tabella-moderna th {
    font-size: 1rem;
    padding: 16px 8px;
  }
  .tabella-moderna td {
    padding: 14px 6px;
    font-size: 0.95rem;
  }
  .input-nome, .input-punti, .input-prob {
    width: 85%;
    padding: 6px 8px;
    font-size: 0.95rem;
  }
  .stato-cerchi {
    min-width: 160px;
    gap: 4px;
  }
  .cerchio {
    width: 16px;
    height: 16px;
  }
}
@media (max-width: 900px) {
  .tabella-moderna {
    width: 100%;
    font-size: 0.95rem;
    border-radius: 10px;
    box-shadow: 0 2px 12px rgba(65,88,208,0.10);
  }
  .tabella-moderna th, .tabella-moderna td {
    padding: 10px 4px;
    font-size: 0.95rem;
  }
  .navbar-custom ul {
    gap: 16px;
  }
  .stato-cerchi {
    min-width: 120px;
    gap: 3px;
  }
.cerchio {
  width: 14px;
  height: 14px;
  }
}

/* Dice Button Styles */
.btn-plus {
  font-size: 2.2rem;
  font-weight: 700;
  color: #fff;
  background: linear-gradient(135deg,#4158d0,#c850c0);
  border: none;
  border-radius: 50%;
  width: 48px;
  height: 48px;
  box-shadow: 0 4px 16px rgba(65,88,208,0.18);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: transform 0.15s, box-shadow 0.15s;
}
.btn-plus:active,
.btn-plus.pressed {
  transform: translateY(2px) scale(0.97);
  box-shadow: 0 2px 8px rgba(65,88,208,0.10);
}
.btn-plus:focus {
  outline: 3px solid rgba(21,156,228,0.18);
  outline-offset: 3px;
}
.dice-button-img:active,
.dice-button-img.pressed {
  transform: translateY(3px) scale(0.98);
  box-shadow: 0 3px 10px rgba(65,88,208,0.12);
}
.dice-button-img:focus {
  outline: 3px solid rgba(21,156,228,0.18);
  outline-offset: 3px;
}

#dice-main-number.illuminated {
  box-shadow: 0 8px 32px rgba(65,88,208,0.5), 0 0 64px rgba(200,80,192,0.5);
}

.voto-display {
  display: inline-block !important;
  width: 90% !important;
  text-align: center !important;
  font-size: 1.5rem !important;
  font-weight: bold !important;
  font-family: 'Arial Black', 'Arial', sans-serif !important;
  color: #4158d0 !important;
  background: transparent !important;
  padding: 8px 12px !important;
}

.voto-low {
  text-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000;
}

.voto-high {
  text-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00;
}

.voto-gold {
  text-shadow: 0 0 5px #ffd700, 0 0 10px #ffd700;
}
</style>
