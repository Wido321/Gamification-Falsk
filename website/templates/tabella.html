{% extends "base.html" %}
{% block title %}Tabella{% endblock %}
{% block content %}
<div class="tabella-container">
  <table class="tabella-moderna">
    <thead>
      <tr>
        <th>#</th>
        <th>Presenza</th>
        <th>Nome</th>
        <th>Stato</th>
        <th>Punti</th>
        <th>Probabilità</th>
  <th></th>
      </tr>
    </thead>
    <tbody>
      {% for row in tabella_data %}
      <tr data-id="{{ row.id }}">
        <input type="hidden" class="stato-hidden" value="{{ row.stato }}">
        <td>{{ row.id }}</td>
        <td><input type="checkbox" {% if row.checked %}checked{% endif %} class="presence-checkbox" data-row="{{ row.id }}"></td>
        <td>{{ row.cognome }}</td>
        <td>
          <div class="stato-cerchi">
            {% for j in range(10) %}
              <span class="cerchio stato-{{ row.id }}-{{ j+1 }}" data-row="{{ row.id }}" data-index="{{ j+1 }}" style="background-color: {% if row.stato[j] == 'G' %}#a7f3bf{% elif row.stato[j] == 'R' %}#ffb6c1{% else %}transparent{% endif %}"></span>
            {% endfor %}
          </div>
        </td>
        <td><input type="text" value="{{ row.punti }}" class="input-punti" readonly data-row="{{ row.id }}"></td>
        <td><input type="text" value="{{ row.probabilita }}%" class="input-prob" readonly data-row="{{ row.id }}"></td>
        <td><button class="btn-plus" data-row="{{ row.id }}" aria-label="Aumenta" title="Aumenta" style="font-size:2.2rem; font-weight:700; color:#fff; background:linear-gradient(135deg,#4158d0,#c850c0); border:none; border-radius:50%; width:48px; height:48px; box-shadow:0 4px 16px rgba(65,88,208,0.18); display:flex; align-items:center; justify-content:center; cursor:pointer; transition:transform 0.15s;">+</button></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Dice Button PNG -->
<div style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
  <div style="position: relative; width: 300px; height: 360px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start;">
    <div id="dice-main-number" style="position: absolute; top: 0; left: 50%; transform: translate(-50%, 0); z-index: 2; width: 300px; height: 300px; background: linear-gradient(135deg,#4158d0,#c850c0); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 5rem; font-family: 'Poppins', sans-serif; font-weight: 800; color: #fff; box-shadow: 0 8px 32px rgba(65,88,208,0.22); border: 6px solid #fff; pointer-events: none; opacity: 0; transition: opacity 0.3s;"></div>
    <button id="diceBtn" class="dice-button-img" aria-label="Lancia il dado" style="background:none; border:none; padding:0; border-radius:50%; box-shadow:0 8px 32px rgba(65,88,208,0.22); cursor:pointer; width:300px; height:300px; display:flex; align-items:center; justify-content:center; overflow:hidden; position: relative;">
  <dotlottie-wc id="main-dice-lottie" src="https://lottie.host/be5df32d-5f20-4015-a1e4-b0b56c8934f8/PfUeITOeEI.lottie" style="width: 300px; height: 300px" autoplay loop></dotlottie-wc>
    </button>
  </div>
</div>

<!-- Overlay domanda -->
<!-- Overlay difficoltà -->
<div id="difficulty-overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(26,11,46,0.85); z-index:3500; justify-content:center; align-items:center;">
  <div style="background:rgba(255,255,255,0.08); border-radius:24px; box-shadow:0 8px 32px rgba(107,43,255,0.2); padding:36px 28px; text-align:center; font-family:'Poppins',sans-serif; font-size:1.9rem; color:#fff; max-width:520px;">
    <div id="difficulty-text" style="margin-bottom:24px; font-size:2rem; font-weight:700;">Che difficoltà deve essere la domanda?</div>
    <div style="display:flex; justify-content:center; gap:12px;">
      <button class="diff-btn" data-diff="facile" style="background:linear-gradient(135deg,#4caf50,#2e7d32); color:#fff; font-size:1.1rem; font-weight:700; border:none; border-radius:12px; padding:12px 20px; cursor:pointer;">Facile</button>
      <button class="diff-btn" data-diff="normale" style="background:linear-gradient(135deg,#ffeb3b,#fbc02d); color:#000; font-size:1.1rem; font-weight:700; border:none; border-radius:12px; padding:12px 20px; cursor:pointer;">Normale</button>
      <button class="diff-btn" data-diff="difficile" style="background:linear-gradient(135deg,#f44336,#d32f2f); color:#fff; font-size:1.1rem; font-weight:700; border:none; border-radius:12px; padding:12px 20px; cursor:pointer;">Difficile</button>
    </div>
  </div>
</div>

<!-- Overlay domanda (dopo scelta difficoltà) -->
<div id="question-overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(26,11,46,0.85); z-index:3000; justify-content:center; align-items:center;">
  <div style="background:rgba(255,255,255,0.08); border-radius:24px; box-shadow:0 8px 32px rgba(107,43,255,0.2); padding:48px 32px; text-align:center; font-family:'Poppins',sans-serif; font-size:2rem; color:#fff; max-width:400px;">
    <div id="question-text" style="margin-bottom:32px; font-size:2.2rem; font-weight:700;">La persona sorteggiata ha risposto correttamente?</div>
    <button id="btn-correct" style="background:linear-gradient(135deg,#4caf50,#43ea7f); color:#fff; font-size:1.3rem; font-weight:600; border:none; border-radius:12px; padding:16px 32px; margin:0 16px; cursor:pointer;">Sì</button>
    <button id="btn-wrong" style="background:linear-gradient(135deg,#e74c3c,#ff6b6b); color:#fff; font-size:1.3rem; font-weight:600; border:none; border-radius:12px; padding:16px 32px; margin:0 16px; cursor:pointer;">No</button>
  </div>
</div>

<!-- Dice Animation Overlay -->
<div id="dice-animation-overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(26,11,46,0.85); z-index:4000; justify-content:center; align-items:center;">
  <div style="position:relative; width:300px; height:300px; display:flex; align-items:center; justify-content:center;">
  <dotlottie-wc id="dice-lottie" src="https://lottie.host/be5df32d-5f20-4015-a1e4-b0b56c8934f8/PfUeITOeEI.lottie" style="width: 300px; height: 300px; position:absolute; left:0; top:0; z-index:1;" autoplay loop></dotlottie-wc>
    <div id="dice-number" style="display:none; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); z-index:2; font-size:5rem; font-family:'Poppins',sans-serif; font-weight:800; color:#fff; text-shadow:0 4px 32px #4158d0,0 2px 8px #c850c0; background:rgba(65,88,208,0.18); border-radius:24px; padding:24px 64px; box-shadow:0 8px 32px rgba(65,88,208,0.18); transition:opacity 0.5s; pointer-events:none;"></div>
  </div>
</div>

<script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.8.1/dist/dotlottie-wc.js" type="module"></script>
<script>
// Funzione per calcolare le probabilità basate sui pallini vuoti
function calculateProbabilities() {
  let totalEmpty = 0;
  const rowEmpties = [];
  for (let r = 1; r <= 22; r++) {
    const checkbox = document.querySelector(`.presence-checkbox[data-row="${r}"]`);
    if (!checkbox || !checkbox.checked) {
      rowEmpties[r-1] = 0;
      continue;
    }
    const cerchi = document.querySelectorAll('.cerchio[data-row="' + r + '"]');
    let emptyCount = 0;
    for (let c of cerchi) {
      const bg = (c.style.backgroundColor || '').trim();
      if (!bg || bg === 'transparent' || bg === 'rgba(0, 0, 0, 0)') {
        emptyCount++;
      }
    }
    rowEmpties[r-1] = emptyCount;
    totalEmpty += emptyCount;
  }
  for (let r = 1; r <= 22; r++) {
    const prob = totalEmpty > 0 ? (rowEmpties[r-1] / totalEmpty) * 100 : 0;
    // Aggiorna input-prob
    const inputProb = document.querySelector(`.input-prob[data-row="${r}"]`);
    if (inputProb) {
      inputProb.value = prob.toFixed(1) + '%';
    }
  }
  return rowEmpties.map(e => totalEmpty > 0 ? e / totalEmpty : 0); // pesi normalizzati, 0 se non presente
}

// Funzione per salvare la tabella
function saveTabella() {
  const data = [];
  document.querySelectorAll('tbody tr').forEach(tr => {
    const id = tr.dataset.id;
    const checked = tr.querySelector('.presence-checkbox').checked;
    const punti = parseInt(tr.querySelector('.input-punti').value) || 0;
    const probabilita = parseFloat(tr.querySelector('.input-prob').value) || 0;
    const stato = tr.querySelector('.stato-hidden').value;
    data.push({id, checked, punti, probabilita, stato});
  });
  fetch('/save_tabella', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  }).then(res => res.json()).then(data => console.log('Saved')).catch(err => console.error('Save failed', err));
}

// Funzione per selezione casuale pesata
function weightedRandom(weights) {
  const total = weights.reduce((a,b)=>a+b,0);
  let random = Math.random() * total;
  for (let i = 0; i < weights.length; i++) {
    random -= weights[i];
    if (random <= 0) return i+1; // righe 1-22
  }
  return 22; // fallback
}

// Dado Lottie con cerchio numero
const diceBtn = document.getElementById('diceBtn');
const diceLottie = document.getElementById('main-dice-lottie');
const diceMainNumber = document.getElementById('dice-main-number');

// All'avvio parte l'animazione, poi si ferma
window.addEventListener('DOMContentLoaded', () => {
  if (diceLottie) {
    diceLottie.setAttribute('autoplay', '');
    diceLottie.removeAttribute('loop');
    setTimeout(() => {
      diceLottie.removeAttribute('autoplay');
      diceLottie.frame = 120;
    }, 2200); // durata animazione
  }
  // Calcola probabilità iniziali
  calculateProbabilities();
});

function showDiceNumber(num) {
  diceMainNumber.textContent = num;
  diceMainNumber.style.opacity = '1';
}

function hideDiceNumber() {
  diceMainNumber.style.opacity = '0';
}

function startDiceAnimation() {
  // Nascondi il dado
  diceLottie.style.display = 'none';
  setTimeout(() => {
    // Mostra e ricomincia animazione
    diceLottie.style.display = '';
    diceLottie.removeAttribute('autoplay');
    diceLottie.frame = 0;
    diceLottie.load?.(diceLottie.src);
    setTimeout(() => {
      diceLottie.setAttribute('autoplay','');
      setTimeout(() => {
        diceLottie.removeAttribute('autoplay');
        diceLottie.frame = 120;
      }, 2200);
    }, 50);
  }, 10);
}

diceBtn.addEventListener('click', function() {
  this.classList.add('pressed');
  setTimeout(()=>this.classList.remove('pressed'), 160);
  // Calcola probabilità e estrai il numero pesato
  const weights = calculateProbabilities();
  const row = weightedRandom(weights);
  // Ricomincia animazione Lottie ogni estrazione
  startDiceAnimation();
  // Mostra subito il numero
  showDiceNumber(row);
  // Apri prima l'overlay di difficoltà; al click su una difficoltà mostriamo la domanda
  showDifficultyChooser(row);
});

// Overlay domanda
function showQuestion(row) {
  const overlay = document.getElementById('question-overlay');
  overlay.style.display = 'flex';
  overlay.dataset.row = row;
}

// Mostra la scelta di difficoltà prima della domanda
function showDifficultyChooser(row) {
  const overlay = document.getElementById('difficulty-overlay');
  overlay.style.display = 'flex';
  overlay.dataset.row = row;
}

// Nascondi chooser
function hideDifficultyChooser() {
  const overlay = document.getElementById('difficulty-overlay');
  overlay.style.display = 'none';
}

// mappa colori: [difficoltà][esito]
const COLOR_MAP = {
  'facile': {
    'correct': '#a7f3bf', // verde chiaro
    'wrong': '#ffb6c1'    // rosa chiaro -> tendente a rosso
  },
  'normale': {
    'correct': '#2e7d32', // verde scuro
    'wrong': '#e53935'    // rosso normale
  },
  'difficile': {
    'correct': '#0b3d0b', // verde molto scuro
    'wrong': '#800020'    // bordò
  }
};

// registra click sui bottoni difficoltà
document.querySelectorAll('.diff-btn').forEach(function(b){
  b.addEventListener('click', function(){
    const diff = b.dataset.diff; // 'facile'|'normale'|'difficile'
    const row = document.getElementById('difficulty-overlay').dataset.row;
    // chiudi chooser e apri la domanda
    hideDifficultyChooser();
    // salviamo la difficoltà scelta nell'overlay domanda per usarla dopo
    const questionOverlay = document.getElementById('question-overlay');
    questionOverlay.dataset.row = row;
    questionOverlay.dataset.diff = diff;
    showQuestion(row);
  });
});
document.getElementById('btn-correct').onclick = function() {
  const row = document.getElementById('question-overlay').dataset.row;
  const diff = document.getElementById('question-overlay').dataset.diff || 'normale';
  // Trova la prima pallina vuota e colorala secondo la mappa
  const cerchi = document.querySelectorAll('.cerchio[data-row="' + row + '"]');
  for (let c of cerchi) {
    const bg = (c.style.backgroundColor || '').trim();
    if (!bg || bg === 'transparent' || bg === 'rgba(0, 0, 0, 0)') {
      c.style.backgroundColor = COLOR_MAP[diff]['correct'];
      break;
    }
  }
  // Aggiorna stato string
  const statoHidden = document.querySelector(`tr[data-id="${row}"] .stato-hidden`);
  let stato = statoHidden.value;
  const index = stato.indexOf('-');
  if (index !== -1) {
    stato = stato.substring(0, index) + 'G' + stato.substring(index+1);
    statoHidden.value = stato;
  }
  // Aggiungi punti
  const inputPunti = document.querySelector(`.input-punti[data-row="${row}"]`);
  let current = parseInt(inputPunti.value) || 0;
  let add = diff === 'facile' ? 10 : diff === 'normale' ? 20 : 50;
  inputPunti.value = current + add;
  document.getElementById('question-overlay').style.display = 'none';
  // Ricalcola probabilità dopo la risposta
  calculateProbabilities();
  // Salva
  saveTabella();
};
document.getElementById('btn-wrong').onclick = function() {
  const row = document.getElementById('question-overlay').dataset.row;
  const diff = document.getElementById('question-overlay').dataset.diff || 'normale';
  // Trova la prima pallina vuota e colorala secondo la mappa
  const cerchi = document.querySelectorAll('.cerchio[data-row="' + row + '"]');
  for (let c of cerchi) {
    const bg = (c.style.backgroundColor || '').trim();
    if (!bg || bg === 'transparent' || bg === 'rgba(0, 0, 0, 0)') {
      c.style.backgroundColor = COLOR_MAP[diff]['wrong'];
      break;
    }
  }
  // Aggiorna stato string
  const statoHidden = document.querySelector(`tr[data-id="${row}"] .stato-hidden`);
  let stato = statoHidden.value;
  const index = stato.indexOf('-');
  if (index !== -1) {
    stato = stato.substring(0, index) + 'R' + stato.substring(index+1);
    statoHidden.value = stato;
  }
  document.getElementById('question-overlay').style.display = 'none';
  // Ricalcola probabilità dopo la risposta
  calculateProbabilities();
  // Salva
  saveTabella();
};

// Colonna +
document.querySelectorAll('.btn-plus').forEach(function(btn) {
  btn.addEventListener('click', function() {
    const row = btn.dataset.row;
    showDifficultyChooser(row);
  });
});
</script>

{% endblock %}
<style>
@import url('https://fonts.googleapis.com/css?family=Poppins:400,500,600,700&display=swap');
body {
  font-family: 'Poppins', 'Segoe UI', Arial, sans-serif;
  background: #f2f2f2;
}
.navbar-custom {
  margin-bottom: 32px;
  padding: 0 0 0 24px;
}
.navbar-custom ul {
  list-style: none;
  display: flex;
  gap: 32px;
  padding: 0;
}
.navbar-custom li {
  display: inline-block;
}
.navbar-custom a {
  color: #4158d0;
  font-weight: 600;
  text-decoration: none;
  font-size: 1.1rem;
  padding: 8px 16px;
  border-radius: 6px;
  transition: background 0.2s;
}
.navbar-custom a:hover {
  background: #e9e9f7;
}
.tabella-container {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 70vh;
  width: 100%;
  padding: 32px 0;
  overflow-x: auto;
}
.tabella-moderna {
  width: 98%;
  max-width: 1100px;
  border-collapse: separate;
  border-spacing: 0;
  background: #fff;
  box-shadow: 0 8px 32px rgba(65,88,208,0.10);
  border-radius: 18px;
  overflow: hidden;
  margin: 0 auto;
  border: 1.5px solid #c850c0;
}
.tabella-moderna th {
  background: linear-gradient(-135deg, #c850c0, #4158d0);
  color: #fff;
  font-size: 1.15rem;
  font-weight: 700;
  padding: 20px 12px;
  border-bottom: 2px solid #4158d0;
  text-align: center;
  letter-spacing: 0.5px;
}
.tabella-moderna td {
  padding: 18px 10px;
  border-bottom: 1px solid #e3e6ee;
  text-align: center;
  font-size: 1.05rem;
  background: #fff;
  transition: background 0.2s;
}
.tabella-moderna tbody tr:nth-child(even) td {
  background: #f7f2fa;
}
.tabella-moderna tbody tr:hover td {
  background: #e9e9f7;
}
.input-nome, .input-punti, .input-prob {
  width: 90%;
  padding: 8px 12px;
  border: 1.5px solid #bfc7e3;
  border-radius: 8px;
  font-size: 1.05rem;
  background: #f7f8fa;
  transition: border 0.2s, background 0.2s;
}
.input-nome:focus, .input-punti:focus, .input-prob:focus {
  border: 2px solid #4158d0;
  background: #fff;
}

.stato-cerchi {
  display: flex;
  flex-wrap: wrap;
  gap: 18px;
  justify-content: center;
  align-items: center;
  min-width: 300px;
  margin: 0 auto;
}
.cerchio {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2.5px solid #c850c0;
  box-shadow: 0 2px 8px rgba(65,88,208,0.10);
  font-size: 2rem;
  font-weight: 700;
  color: #fff;
  background: transparent;
}

@media (max-width: 1024px) and (min-width: 901px) {
  .tabella-moderna {
    width: 100%;
    max-width: none;
  }
  .tabella-moderna th {
    font-size: 1rem;
    padding: 16px 8px;
  }
  .tabella-moderna td {
    padding: 14px 6px;
    font-size: 0.95rem;
  }
  .input-nome, .input-punti, .input-prob {
    width: 85%;
    padding: 6px 8px;
    font-size: 0.95rem;
  }
  .stato-cerchi {
    min-width: 160px;
    gap: 4px;
  }
  .cerchio {
    width: 16px;
    height: 16px;
  }
}
@media (max-width: 900px) {
  .tabella-moderna {
    width: 100%;
    font-size: 0.95rem;
    border-radius: 10px;
    box-shadow: 0 2px 12px rgba(65,88,208,0.10);
  }
  .tabella-moderna th, .tabella-moderna td {
    padding: 10px 4px;
    font-size: 0.95rem;
  }
  .navbar-custom ul {
    gap: 16px;
  }
  .stato-cerchi {
    min-width: 120px;
    gap: 3px;
  }
.cerchio {
  width: 14px;
  height: 14px;
  }
}

/* Dice Button Styles */
.btn-plus {
  font-size: 2.2rem;
  font-weight: 700;
  color: #fff;
  background: linear-gradient(135deg,#4158d0,#c850c0);
  border: none;
  border-radius: 50%;
  width: 48px;
  height: 48px;
  box-shadow: 0 4px 16px rgba(65,88,208,0.18);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: transform 0.15s, box-shadow 0.15s;
}
.btn-plus:active,
.btn-plus.pressed {
  transform: translateY(2px) scale(0.97);
  box-shadow: 0 2px 8px rgba(65,88,208,0.10);
}
.btn-plus:focus {
  outline: 3px solid rgba(21,156,228,0.18);
  outline-offset: 3px;
}
.dice-button-img:active,
.dice-button-img.pressed {
  transform: translateY(3px) scale(0.98);
  box-shadow: 0 3px 10px rgba(65,88,208,0.12);
}
.dice-button-img:focus {
  outline: 3px solid rgba(21,156,228,0.18);
  outline-offset: 3px;
}
</style>
